<!DOCTYPE html>
<html lang="en">
<head>
    <title>MTL Survival Map</title>
    <meta charset="utf-8" />
    <link href="./maplibre-gl.css" rel="stylesheet" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; background: #020617; }
        #map { width: 100%; height: 100vh; }
    </style>
</head>
<body>

    <div id="map"></div>

    <script src="./pmtiles.js"></script>
    <script src="./maplibre-gl.js"></script>

    
    <script>
    // 1. Initialize Protocol
const protocol = new pmtiles.Protocol();
maplibregl.addProtocol("pmtiles", protocol.add.bind(protocol));

// 2. Use the exact relative path for GitHub Pages
const GITHUB_RAW_URL = "./montreal.pmtiles"; 

const map = new maplibregl.Map({
    container: 'map',
    // 3. Updated transformRequest logic
    transformRequest: (url, resourceType) => {
        // This ensures MapLibre knows it's a PMTiles request 
        // and doesn't try to read it as a JSON style
        if (url.startsWith('pmtiles://')) {
            return {
                url: url.replace('pmtiles://', ''),
                headers: { 'Range': 'bytes=0-' }
            };
        }
        return { url };
    },
    style: {
        "version": 8,
        "sources": {
            "protomaps": {
                "type": "vector",
                // IMPORTANT: Ensure the URL starts with pmtiles:// 
                // so the protocol intercepts it
                "url": "pmtiles://" + GITHUB_RAW_URL,
                "attribution": "Â© OSM"
            }
        },
        "layers": [
            {
                "id": "background",
                "type": "background",
                "paint": { "background-color": "#020617" }
            },
            {
                "id": "water",
                "source": "protomaps",
                "source-layer": "water",
                "type": "fill",
                "paint": { "fill-color": "#0ea5e9" }
            },
            {
                "id": "roads",
                "source": "protomaps",
                "source-layer": "roads",
                "type": "line",
                "paint": { "line-color": "#334155", "line-width": 1 }
            }
        ]
    },
    center: [-73.5878, 45.5088],
    zoom: 12
});

map.on('load', () => {
    console.log("SUCCESS: Map fully loaded.");
});

    </script>
</body>
</html>
